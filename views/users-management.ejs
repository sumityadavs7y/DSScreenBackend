<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/head') %>
    <title>User Management - Digital Signage</title>
    <style>
        body { background: #f8f9fa; min-height: 100vh; padding-bottom: 50px; }
        .page-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .content-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .role-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .role-owner { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; }
        .role-admin { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .role-manager { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .role-member { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .role-viewer { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; }
    </style>
</head>
<body>
    <%- include('partials/navbar', { user, company, userCompany, session }) %>

    <div class="container mt-5 mb-5">
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2"><i class="bi bi-people-fill"></i> User Management</h1>
                    <p class="mb-0 opacity-75">Manage team members for <%= company.name %></p>
                </div>
                <a href="/dashboard/videos" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="mb-0">Team Members (<%= users.length %>)</h4>
                    <small class="text-muted">Add, edit, or remove users from your company</small>
                </div>
                <div>
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="bi bi-plus-lg"></i> Add User
                    </button>
                    <input type="text" id="searchInput" class="form-control form-control-sm d-inline-block w-auto" placeholder="Search users...">
                </div>
            </div>

            <% if (users.length === 0) { %>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No users yet. Click "Add User" to invite team members.
                </div>
            <% } else { %>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <% users.forEach(u => { %>
                                <tr data-user-email="<%= u.email.toLowerCase() %>">
                                    <td>
                                        <strong><%= u.firstName %> <%= u.lastName %></strong>
                                        <br><small class="text-muted"><%= u.email %></small>
                                        <% if (u.phoneNumber) { %>
                                            <br><small class="text-muted"><i class="bi bi-telephone"></i> <%= u.phoneNumber %></small>
                                        <% } %>
                                    </td>
                                    <td>
                                        <span class="role-badge role-<%= u.role %>">
                                            <%= u.role.charAt(0).toUpperCase() + u.role.slice(1) %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (u.isActive) { %>
                                            <span class="badge bg-success">Active</span>
                                        <% } else { %>
                                            <span class="badge bg-danger">Inactive</span>
                                        <% } %>
                                    </td>
                                    <td><%= new Date(u.joinedAt).toLocaleDateString() %></td>
                                    <td>
                                        <% if (u.lastLoginAt) { %>
                                            <%= new Date(u.lastLoginAt).toLocaleDateString() %>
                                        <% } else { %>
                                            <span class="text-muted">Never</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (String(u.id) === String(user.id)) { %>
                                            <button class="btn btn-sm btn-secondary" disabled title="You cannot edit yourself here">
                                                <i class="bi bi-person-circle"></i>
                                            </button>
                                        <% } else { %>
                                            <button class="btn btn-sm btn-primary me-1" onclick="editUser('<%= u.id %>')" title="Edit User">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="removeUser('<%= u.id %>', '<%= u.firstName %> <%= u.lastName %>')" title="Remove from Company">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-plus-fill"></i> Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">First Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="firstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="lastName" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" name="phoneNumber">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" name="password" minlength="8" required>
                            <small class="text-muted">Minimum 8 characters</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" name="role" required>
                                <option value="member" selected>Member</option>
                                <option value="viewer">Viewer</option>
                                <option value="manager">Manager</option>
                                <% if (userCompany.role === 'owner') { %>
                                    <option value="admin">Admin</option>
                                <% } %>
                            </select>
                            <small class="text-muted">
                                • Viewer: Can only view<br>
                                • Member: Can view and create<br>
                                • Manager: Can view, create, and manage<br>
                                • Admin: Full access except owner-level actions
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addUser()">
                        <i class="bi bi-person-plus-fill"></i> Add User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-fill"></i> Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">First Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editFirstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editLastName" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="editEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="editPhoneNumber">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="editPassword" minlength="8">
                            <small class="text-muted">Leave blank to keep current password</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="editRole" required>
                                <option value="member">Member</option>
                                <option value="viewer">Viewer</option>
                                <option value="manager">Manager</option>
                                <% if (userCompany.role === 'owner') { %>
                                    <option value="admin">Admin</option>
                                <% } %>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">
                        <i class="bi bi-check-lg"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/scripts') %>
    <script>
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#usersTable tr');
            
            rows.forEach(row => {
                const email = row.getAttribute('data-user-email');
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm) || email.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Add user
        async function addUser() {
            const form = document.getElementById('addUserForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/dashboard/users/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Add user error:', error);
                alert('Error adding user');
            }
        }

        // Edit user - load data
        async function editUser(userId) {
            try {
                const users = <%- JSON.stringify(users) %>;
                const user = users.find(u => u.id === userId);

                if (!user) {
                    alert('User not found');
                    return;
                }

                document.getElementById('editUserId').value = user.id;
                document.getElementById('editFirstName').value = user.firstName;
                document.getElementById('editLastName').value = user.lastName;
                document.getElementById('editEmail').value = user.email;
                document.getElementById('editPhoneNumber').value = user.phoneNumber || '';
                document.getElementById('editPassword').value = '';
                document.getElementById('editRole').value = user.role;

                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            } catch (error) {
                console.error('Edit user error:', error);
                alert('Error loading user data');
            }
        }

        // Update user
        async function updateUser() {
            const form = document.getElementById('editUserForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const userId = document.getElementById('editUserId').value;
            const data = {
                firstName: document.getElementById('editFirstName').value,
                lastName: document.getElementById('editLastName').value,
                email: document.getElementById('editEmail').value,
                phoneNumber: document.getElementById('editPhoneNumber').value,
                password: document.getElementById('editPassword').value,
                role: document.getElementById('editRole').value,
            };

            try {
                const response = await fetch(`/dashboard/users/${userId}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Update user error:', error);
                alert('Error updating user');
            }
        }

        // Remove user
        async function removeUser(userId, userName) {
            if (!confirm(`Are you sure you want to remove ${userName} from this company?`)) {
                return;
            }

            try {
                const response = await fetch(`/dashboard/users/${userId}/remove`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Remove user error:', error);
                alert('Error removing user');
            }
        }
    </script>
</body>
</html>

