<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
            padding: 2rem;
            font-family: 'Courier New', monospace;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }
        .card {
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .video-item {
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
        }
        .badge-order {
            background: #667eea;
            color: white;
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“‹ Timeline Details</h1>
            <p class="mb-0">Device Registration & Playlist Information</p>
        </div>

        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Device Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Device UID:</strong> <span id="deviceUID">-</span></p>
                <p class="mb-0"><strong>Registered:</strong> <span id="registered">-</span></p>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Playlist Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Playlist Name:</strong> <span id="playlistName">-</span></p>
                <p><strong>Playlist ID:</strong> <span id="playlistID">-</span></p>
                <p><strong>Playlist Code:</strong> <span id="playlistCode">-</span></p>
                <p><strong>Total Videos:</strong> <span id="totalVideos">-</span></p>
                <p class="mb-0"><strong>Total Duration:</strong> <span id="totalDuration">-</span></p>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Timeline Items (Playback Order)</h5>
            </div>
            <div class="card-body" id="timelineItems">
                <p class="text-muted">Loading...</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Raw JSON Data</h5>
            </div>
            <div class="card-body">
                <pre id="rawData">Loading...</pre>
            </div>
        </div>

        <div class="text-center">
            <button class="btn btn-primary" onclick="location.reload()">Refresh</button>
            <button class="btn btn-secondary" onclick="goHome()">Back to Home</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', loadTimelineDetails);

        async function loadTimelineDetails() {
            const registrationData = localStorage.getItem('devicePlaylistRegistration');
            
            if (!registrationData) {
                document.getElementById('timelineItems').innerHTML = '<div class="alert alert-danger">No registration data found. Please register a device first.</div>';
                return;
            }

            try {
                const data = JSON.parse(registrationData);
                const playlist = data.playlist;

                // Device Info
                document.getElementById('deviceUID').textContent = localStorage.getItem('deviceUID') || 'Unknown';
                document.getElementById('registered').textContent = new Date().toLocaleString();

                // Playlist Info
                document.getElementById('playlistName').textContent = playlist.name || 'N/A';
                document.getElementById('playlistID').textContent = playlist.id || 'N/A';
                document.getElementById('playlistCode').textContent = playlist.code || 'N/A';
                document.getElementById('totalVideos').textContent = playlist.items ? playlist.items.length : 0;

                // Calculate total duration
                let totalDuration = 0;
                if (playlist.items) {
                    totalDuration = playlist.items.reduce((sum, item) => sum + (item.duration || 0), 0);
                }
                document.getElementById('totalDuration').textContent = formatTime(totalDuration);

                // Display timeline items
                if (playlist.items && playlist.items.length > 0) {
                    const sortedItems = [...playlist.items].sort((a, b) => a.order - b.order);
                    
                    let html = '';
                    sortedItems.forEach((item, index) => {
                        html += `
                            <div class="video-item">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="badge-order">${index + 1}</div>
                                    <div class="flex-grow-1">
                                        <h5>${item.video.fileName || 'Unknown'}</h5>
                                        <p class="mb-2">
                                            <strong>Duration:</strong> ${formatTime(item.duration || 0)} (${item.duration}s)<br>
                                            <strong>Order:</strong> ${item.order}<br>
                                            <strong>Video ID:</strong> ${item.video.id}<br>
                                            <strong>File Path:</strong> ${item.video.filePath || 'N/A'}<br>
                                            <strong>MIME Type:</strong> ${item.video.mimeType || 'N/A'}<br>
                                            <strong>Resolution:</strong> ${item.video.resolution || 'N/A'}<br>
                                            <strong>File Size:</strong> ${formatFileSize(item.video.fileSize)}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('timelineItems').innerHTML = html;
                } else {
                    document.getElementById('timelineItems').innerHTML = '<div class="alert alert-warning">No videos in timeline</div>';
                }

                // Raw JSON
                document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('timelineItems').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                document.getElementById('rawData').textContent = error.stack;
            }
        }

        function formatTime(seconds) {
            const s = Math.floor(seconds);
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            
            if (h > 0) {
                return `${h}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            }
            return `${m}:${String(sec).padStart(2, '0')}`;
        }

        function formatFileSize(bytes) {
            if (!bytes) return 'N/A';
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function goHome() {
            if (confirm('Clear registration and go back to home?')) {
                localStorage.removeItem('devicePlaylistRegistration');
                localStorage.removeItem('deviceUID');
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>
