<%
// Set default for session if not provided
if (typeof session === 'undefined') {
    session = null;
}
%>
<!-- Main Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="<%= typeof company !== 'undefined' ? '/dashboard/videos' : '/admin' %>">
            <i class="bi bi-tv"></i> dsScreen
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <% 
                const isImpersonating = typeof session !== 'undefined' && session && session.impersonating;
                const isSuperAdmin = user && user.isSuperAdmin;
                %>
                <% if (isImpersonating) { %>
                    <li class="nav-item me-3">
                        <button class="btn btn-sm btn-warning" onclick="exitImpersonation()" style="font-weight: 600;">
                            <i class="bi bi-arrow-left-circle"></i> Back to Admin Panel
                        </button>
                    </li>
                <% } else if (isSuperAdmin) { %>
                    <li class="nav-item me-3">
                        <a class="nav-link" href="/admin" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 8px; padding: 8px 16px; font-weight: 600;">
                            <i class="bi bi-shield-fill-check"></i> Super Admin Panel
                        </a>
                    </li>
                <% } %>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i> <%= user.firstName %> <%= user.lastName %>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <% if (typeof company !== 'undefined' && company && typeof userCompany !== 'undefined' && userCompany) { %>
                            <li><h6 class="dropdown-header"><%= company.name %></h6></li>
                            <li><span class="dropdown-item-text">
                                <small class="text-muted">
                                    <% if (userCompany.isSuperAdminAccess) { %>
                                        <i class="bi bi-shield-check"></i> Accessing as <%= userCompany.role %>
                                    <% } else { %>
                                        Role: <%= userCompany.role %>
                                    <% } %>
                                </small>
                            </span></li>
                            <li><hr class="dropdown-divider"></li>
                        <% } %>
                        <% if (user && user.isSuperAdmin) { %>
                            <li>
                                <a class="dropdown-item" href="/admin">
                                    <i class="bi bi-shield-fill-check"></i> Super Admin Panel
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                        <% } %>
                        <% if (typeof company !== 'undefined' && company) { %>
                            <li>
                                <a class="dropdown-item" href="/dashboard/license">
                                    <i class="bi bi-file-text"></i> License Details
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                        <% } %>
                        <li>
                            <form action="/logout" method="POST">
                                <button type="submit" class="dropdown-item">
                                    <i class="bi bi-box-arrow-right"></i> Logout
                                </button>
                            </form>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<script>
function exitImpersonation() {
    if (!confirm('Return to Super Admin Panel?')) return;
    
    fetch('/admin/exit-impersonation', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/admin';
            } else {
                alert(data.message || 'Error exiting impersonation');
            }
        })
        .catch(err => {
            console.error(err);
            alert('Error exiting impersonation');
        });
}
</script>

